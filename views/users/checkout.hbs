<div class="breadcrumb-area bg-gray menuBarTop">
    <div class="container">
        <div class="breadcrumb-content text-center">
            <ul>
                <li>
                    <a href="/viewAll">Home</a>
                </li>
                <li>
                    <a href="/cart">Cart</a>
                </li>
                <li class="active">Checkout </li>
            </ul>
        </div>
    </div>
</div>
<div class="checkout-main-area pt-50 pb-120">
    <div class="container">
        {{!-- <div class="customer-zone mb-20">
            <p class="cart-page-title">Returning customer? <a class="checkout-click1" href="#">Click here to login</a>
            </p>
            <div class="checkout-login-info">
                <p>If you have shopped with us before, please enter your details in the boxes below. If you are a new
                    customer, please proceed to the Billing & Shipping section.</p>
                <form action="#">
                    <div class="row">
                        <div class="col-lg-6 col-md-6">
                            <div class="sin-checkout-login">
                                <label>Username or email address <span>*</span></label>
                                <input type="text" name="user-name">
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="sin-checkout-login">
                                <label>Passwords <span>*</span></label>
                                <input type="password" name="user-password">
                            </div>
                        </div>
                    </div>
                    <div class="button-remember-wrap">
                        <button class="button" type="submit">Login</button>
                        <div class="checkout-login-toggle-btn">
                            <input type="checkbox">
                            <label>Remember me</label>
                        </div>
                    </div>
                    <div class="lost-password">
                        <a href="#">Lost your password?</a>
                    </div>
                </form>
                <div class="checkout-login-social">
                    <span>Login with:</span>
                    <ul>
                        <li><a href="#">Facebook</a></li>
                        <li><a href="#">Twitter</a></li>
                        <li><a href="#">Google</a></li>
                    </ul>
                </div>
            </div>
        </div> --}}
        {{!-- <div class="customer-zone mb-20">
            <p class="cart-page-title">Have a coupon? <a class="checkout-click3" href="#">Click here to enter your
                    code</a></p>
            <div class="checkout-login-info3">
                <form action="#">
                    <input type="text" placeholder="Coupon code">
                    <input type="submit" value="Apply Coupon">
                </form>
            </div>
        </div> --}}

        <form id="checkout-form" action="#" method="post">
            <div class="checkout-wrap pt-20">

                <div class="row">

                    <div class="col-lg-6">
                        <div class="billing-info-wrap mr-50">

                            <h3>Billing Details</h3>
                            <div class="row">
                                {{#each Address}}

                                <div class="col-lg-6">

                                    <div class="card p-0 mb-4" style="width: 12rem;height:10rem">
                                        <div class="card-body">
                                            <h5 class="card-title"><b id="addName">{{Name}},</b></h5>
                                            <p class="card-text"> <b id="addCity">{{City}}, {{State}},</b></p>
                                            <p class="card-text"><b id="addCountry">{{Country}}-{{Pincode}}</b></p>
                                            <div class="d-flex">
                                                <label class="me-2 mt-2" for="">Select Address ?</label>
                                                <input style="width:20px;" type="radio" value="{{_id}}" name="address">
                                            </div>

                                        </div>
                                    </div>



                                    {{!-- <div class="billing-select mb-20">
                                        <label>Choose Your Address <abbr class="required"
                                                title="required">*</abbr></label>
                                        <select placeholder="Please" id="address">
                                            <option>Select</option>
                                            {{#each Address}}

                                            <option name="addressId" value="{{_id}}">
                                                {{Name}},{{City}},{{State}},{{Pincode}}
                                            </option>
                                            {{/each}}

                                        </select>
                                    </div> --}}
                                    {{!-- <h4>Delivery Address</h4> --}}
                                </div>
                                {{/each}}
                            </div>
                            <input type="hidden" id="userId" name="userId" value="{{User}}">
                            <a href="/add-address" class="btn btn-outline-danger ">Add New Address</a>

                            
                        </div>
                    </div>
                    <form action="" method="post" class="needs-validation" method="post" novalidate>

                                
                    
                    <div class="col-lg-6">
                        <div class="your-order-area">
                            <div>
                                <div class="title-wrap">
                                    <h3 class="cart-bottom-title section-bg-gray">Use Coupon Code</h3>
                        
                    <input type="hidden" name="couponAmount" id="couponAmount">
                    <div>
                                    <h3 hidden class="fw-normal text-center my-4" id="totalPricecheckout"> {{subtotal}}
                                    </h3>
                                    <input type="hidden" id="actualAmount" value="{{subtotal}}">
                                </div>
                                </div>
                                <div class="discount-code">
                                    {{!-- <p>Enter your coupon code if you have one. --}}
                                        <span class="text-danger font-weight-bold" id="error-message"></span>
                                        <span class="text-success font-weight-bold" id="message"></span>
                                    {{!-- </p> --}}
                                   
                                        <input class="border mb-3"  placeholder="Coupon code" type="text" id="promocard" name="couponCode">

                                       
                                        <button onclick="redeemCoupon()" id="add"
                                            class="cart-btn-2 float-right mt-2 mb-2 btn btn-outline-success btn-sm ">Apply
                                            Coupon</button>
                                            
                                        <button onclick="removeCoupon()" id="remove" style="display:none ;"
                                            class="cart-btn-2 float-right mt-2 mb-2 btn btn-outline-danger btn-sm ">Remove
                                            Coupon</button>
                                    </form>
                                </div>
                            </div>
                            <h3>Your order</h3>
                            <div class="your-order-wrap gray-bg-4">
                                <div class="your-order-info-wrap">
                                    <div class="your-order-info">
                                        <ul>
                                            <li>Product <span>Total</span></li>
                                        </ul>
                                    </div>
                                    <div class="your-order-middle">
                                        <ul>

                                            {{#each CartItems}}
                                            <li> {{productname}} ({{price}}) X {{quantity}} <span>Rs. {{sum}}
                                                </span></li>
                                            {{/each}}



                                        </ul>
                                    </div>

                                    <div class="your-order-info order-subtotal">
                                        <ul>
                                            <li>Subtotal <span id="subTotal">{{subtotal}} </span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="your-order-info order-shipping">
                                        <ul>
                                            <li>Apply Coupon <p class="text-success" id="coupon"></p>
                                            </li>
                                            <li class="text-success" id="offerDetail"></li>
                                        </ul>
                                    </div>
                                    <div class="your-order-info order-total">
                                        <ul>
                                            <li>Total <span id="last-amount">{{subtotal}} </span></li>
                                            <input type="hidden" id="total" name="total" value="{{subtotal}}">
                                        </ul>
                                    </div>
                                </div>
                                <div class="payment-method">
                                    <div class="pay-top sin-payment">
                                        {{!-- checked="checked" --}}
                                        <input id="payment-method-3" class="input-radio" type="radio" value="3"
                                            name="payment_method">
                                        <label for="payment-method-3">Cash on delivery </label>
                                        <div class="payment-box payment_method_bacs">
                                            <p>Pay cash Only on Delivery.</p>
                                        </div>
                                    </div>

                                    <div class="pay-top sin-payment sin-payment-3">
                                        <input id="payment-method-4" class="input-radio" type="radio" value="1"
                                            name="payment_method">
                                        <label for="payment-method-4">PayPal <img alt=""
                                                src="assets/images/icon-img/payment.png"><a href="#">What is
                                                PayPal?</a></label>
                                        <div class="payment-box payment_method_bacs">
                                            <p>Paypal</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="Place-order">
                                {{!-- <a href="/viewAll">Place Order</a> --}}
                                <button class="btn btn-outline-danger" onclick=" Order()" type="submit">Place
                                    Order</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </form>
    </div>
</div>

<script>
    async function Order() {
        const selectedMethod = $("input[type='radio'][name='payment_method']:checked").val();
        const selectedAdress = $("input[type='radio'][name='address']:checked").val();
        const userId = document.getElementById('userId').value;
        const total = document.getElementById('total').value;
        
        const orderDetails = {
            selectedMethod: selectedMethod,
            selectedAdress: selectedAdress,
            userId: userId,
            total: total
        }
        const orderplacement = await fetch('/place-order', {
            method: 'post',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderDetails)
        })
        let res = await orderplacement.json()
        if (res == 'success') {
            Swal.fire({
                title: 'Success',
                text: "Order Plcaed Successfully !",
                icon: 'success',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'OK',
                timer: 30000
            }).then(() => {
                document.location.href = '/profile'
            })
        } else if (res.method == 'paypal') {
            document.location.href = '/paypal-checkout/' + userId + '/' + total + '/' + res.address
        }
        else {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong!',
            })
        }
    }

    async function redeemCoupon() {
        const coupon = document.getElementById('promocard').value
        let response = await fetch('/redeem-coupon', {
            method: 'put',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ coupon: coupon }),
        });
        let result = await response.json();
        if (result.error) {
            document.getElementById('error-message').innerText = result.error
        } else {
            const amount = result.amount
            const actualAmount = document.getElementById('actualAmount').value
            const discountAmount = actualAmount * amount / 100
            const newAmount = actualAmount - discountAmount
            document.getElementById('message').innerText = result.message
            document.getElementById('couponAmount').value = amount
            document.getElementById('total').value = newAmount
            document.getElementById('last-amount').innerText = newAmount
            document.getElementById("totalPricecheckout").innerText = newAmount
            document.getElementById('coupon').innerText = discountAmount
            document.getElementById('error-message').innerText = ""
        }
    }

</script>
